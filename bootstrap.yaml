---

- hosts: all
  become: yes
  gather_facts: true
  vars_files:
    - 'vars/vault.yaml'
  tasks:

  - name: Apt Update
    apt:
      upgrade: 'yes'
      update_cache: yes
      cache_valid_time: 3600
  
  - name: Install Sudo
    apt:
      name: sudo
      state: present

  - name: Ensure User Groups Exist
    group:
      name: "{{ item.name }}"
      gid: "{{ item.gid }}"
      state: present
    with_items:
      - { name: "{{ main_username }}", gid: "{{ main_gid }}" }
      - { name: "{{ ansible_username }}", gid: "{{ ansible_gid }}" }

  - name: Add Users
    user:
      name: "{{ item.name }}"
      password: "{{ item.password }}"
      uid: "{{ item.uid }}"
      groups:
        - "{{ item.groups }}"
        - sudo
      shell: /bin/bash
    with_items:
      - { name: "{{ main_username }}", password: "{{ secret_main_pass }}", uid: "{{ main_uid }}", groups: "{{ main_username }}" }
      - { name: "{{ ansible_username }}", password: "{{ secret_ansible_pass }}", uid: "{{ ansible_uid }}", groups: "{{ ansible_username }}" }

#  - name: Add main user
#    user:
#      name: "{{ main_username }}"
#      password: "{{ secret_main_pass }}"
#      uid: "{{ main_uid }}"
#      group: 
#        - "{{ main_username }}"
#      groups:
#        - sudo
#      shell: /bin/bash
#
#  - name: Add ansible user
#    user:
#      name: "{{ ansible_username }}"
#      password: "{{ secret_ansible_pass }}"
#      uid: "{{ ansible_uid }}"
#      group: 
#        - "{{ ansible_username }}"
#      groups:
#        - sudo
#      shell: /bin/bash

  - name: Add Sudoers file for Ansible
    copy:
      src: sudoer_ansible
      dest: /etc/sudoers.d/ansible
      owner: root
      group: root
      mode: 0440

  - name: SSH Keys - Add Ansible
    authorized_key:
      user: "{{ ansible_username }}"
      state: present
      key: "{{ lookup('file', '/home/souldeity/.ssh/id_ansible.pub') }}"
  - name: SSH Keys - Add Main User's from GitHub
    authorized_key:
      user: "{{ main_username }}"
      state: present
      key: https://github.com/souldeity.keys

  - name: Add hardened SSH config
    copy:
      src: sshd_config
      dest: /etc/ssh/sshd_config
      owner: root
      group: root
      mode: 0600

  - name: Restart SSH
    service:
      name: sshd
      state: restarted
